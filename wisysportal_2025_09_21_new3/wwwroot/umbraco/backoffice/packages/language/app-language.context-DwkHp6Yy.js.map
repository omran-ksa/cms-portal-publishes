{"version":3,"file":"app-language.context-DwkHp6Yy.js","sources":["../../../src/packages/language/global-contexts/app-language.context.ts"],"sourcesContent":["import { UmbLanguageCollectionRepository } from '../collection/index.js';\r\nimport type { UmbLanguageDetailModel } from '../types.js';\r\nimport { UMB_APP_LANGUAGE_CONTEXT } from './app-language.context-token.js';\r\nimport { UmbArrayState, UmbObjectState } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbApi } from '@umbraco-cms/backoffice/extension-api';\r\nimport { UmbReadOnlyStateManager } from '@umbraco-cms/backoffice/utils';\r\nimport { UMB_CURRENT_USER_CONTEXT } from '@umbraco-cms/backoffice/current-user';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UmbVariantContext } from '@umbraco-cms/backoffice/variant';\r\n\r\n// TODO: Make a store for the App Languages.\r\n// TODO: Implement default language end-point, in progress at backend team, so we can avoid getting all languages.\r\nexport class UmbAppLanguageContext extends UmbContextBase implements UmbApi {\r\n\t#languagesResolve!: () => void;\r\n\t#languagesPromise = new Promise<void>((resolve) => {\r\n\t\tthis.#languagesResolve = resolve;\r\n\t});\r\n\t#languages = new UmbArrayState<UmbLanguageDetailModel>([], (x) => x.unique);\r\n\tpublic readonly languages = this.#languages.asObservable();\r\n\tpublic readonly cultures = this.#languages.asObservablePart((x) => x.map((y) => y.unique));\r\n\tasync getCultures() {\r\n\t\treturn (await this.observe(this.languages).asPromise()).map((x) => x.unique);\r\n\t}\r\n\r\n\tpublic readonly appDefaultLanguage = this.#languages.asObservablePart((languages) =>\r\n\t\tlanguages.find((language) => language.isDefault),\r\n\t);\r\n\r\n\tpublic readonly moreThanOneLanguage = this.#languages.asObservablePart((x) => x.length > 1);\r\n\r\n\t#appLanguage = new UmbObjectState<UmbLanguageDetailModel | undefined>(undefined);\r\n\tpublic readonly appLanguage = this.#appLanguage.asObservable();\r\n\tpublic readonly appLanguageCulture = this.#appLanguage.asObservablePart((x) => x?.unique);\r\n\r\n\t// TODO: I think we should move all read only states to this context and then make a observable regarding the read only state of the app language. [NL]\r\n\tpublic readonly appLanguageReadOnlyState = new UmbReadOnlyStateManager(this);\r\n\r\n\tpublic readonly appMandatoryLanguages = this.#languages.asObservablePart((languages) =>\r\n\t\tlanguages.filter((language) => language.isMandatory),\r\n\t);\r\n\tasync getMandatoryLanguages() {\r\n\t\tawait this.#languagesPromise;\r\n\t\treturn this.#languages.getValue().filter((language) => language.isMandatory);\r\n\t}\r\n\r\n\t#languageCollectionRepository = new UmbLanguageCollectionRepository(this);\r\n\t#currentUserAllowedLanguages: Array<string> = [];\r\n\t#currentUserHasAccessToAllLanguages = false;\r\n\r\n\t#readOnlyStateIdentifier = 'UMB_LANGUAGE_PERMISSION_';\r\n\t#localStorageKey = 'umb:appLanguage';\r\n\r\n\t#variantContext = new UmbVariantContext(this);\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_APP_LANGUAGE_CONTEXT);\r\n\r\n\t\t// TODO: We need to ensure this request is called every time the user logs in, but this should be done somewhere across the app and not here [JOV]\r\n\t\tthis.consumeContext(UMB_AUTH_CONTEXT, (authContext) => {\r\n\t\t\tthis.observe(authContext?.isAuthorized, (isAuthorized) => {\r\n\t\t\t\tif (!isAuthorized) return;\r\n\t\t\t\tthis.#requestLanguages();\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_CURRENT_USER_CONTEXT, (context) => {\r\n\t\t\tthis.observe(context?.languages, (languages) => {\r\n\t\t\t\tthis.#currentUserAllowedLanguages = languages || [];\r\n\t\t\t\tthis.#setIsReadOnly();\r\n\t\t\t});\r\n\r\n\t\t\tthis.observe(context?.hasAccessToAllLanguages, (hasAccessToAllLanguages) => {\r\n\t\t\t\tthis.#currentUserHasAccessToAllLanguages = hasAccessToAllLanguages || false;\r\n\t\t\t\tthis.#setIsReadOnly();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tgetAppCulture() {\r\n\t\treturn this.#appLanguage.getValue()?.unique;\r\n\t}\r\n\r\n\tsetLanguage(unique: string) {\r\n\t\t// clear the previous read-only state\r\n\t\tconst appLanguage = this.#appLanguage.getValue();\r\n\t\tif (appLanguage?.unique) {\r\n\t\t\tthis.appLanguageReadOnlyState.removeState(this.#readOnlyStateIdentifier + appLanguage.unique);\r\n\t\t}\r\n\r\n\t\t// find the language\r\n\t\tconst language = this.#findLanguage(unique);\r\n\r\n\t\tif (!language) {\r\n\t\t\tthrow new Error(`Language with unique ${unique} not found`);\r\n\t\t}\r\n\r\n\t\t// set the new language\r\n\t\tthis.#appLanguage.update(language);\r\n\r\n\t\t// Update the variant context with the new language\r\n\t\tthis.#variantContext.setCulture(language.unique);\r\n\t\tthis.#variantContext.setAppCulture(language.unique);\r\n\r\n\t\t// store the new language in local storage\r\n\t\tlocalStorage.setItem(this.#localStorageKey, language?.unique);\r\n\r\n\t\t// set the new read-only state\r\n\t\tthis.#setIsReadOnly();\r\n\t}\r\n\r\n\tasync #requestLanguages() {\r\n\t\tconst { data } = await this.#languageCollectionRepository.requestCollection({});\r\n\r\n\t\t// TODO: make this observable / update when languages are added/removed/updated\r\n\t\tif (data) {\r\n\t\t\tthis.#languages.setValue(data.items);\r\n\t\t\tthis.#languagesResolve();\r\n\r\n\t\t\t// If the app language is not set, set it to the default language\r\n\t\t\tif (!this.#appLanguage.getValue()) {\r\n\t\t\t\tthis.#initAppLanguage();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t#initAppLanguage() {\r\n\t\tconst defaultLanguageUnique = this.#languages.getValue().find((x) => x.isDefault)?.unique;\r\n\t\t// TODO: do we always have a default language?\r\n\t\t// do we always get the default language on the first request, or could it be on page 2?\r\n\t\t// in that case do we then need an endpoint to get the default language?\r\n\t\tif (!defaultLanguageUnique) return;\r\n\r\n\t\tthis.#variantContext.setFallbackCulture(defaultLanguageUnique);\r\n\r\n\t\t// get the selected language from local storage\r\n\t\tconst uniqueFromLocalStorage = localStorage.getItem(this.#localStorageKey);\r\n\t\tconst languageFromLocalStorage = this.#findLanguage(uniqueFromLocalStorage || '');\r\n\t\tconst languageUniqueToSet = languageFromLocalStorage ? languageFromLocalStorage.unique : defaultLanguageUnique;\r\n\r\n\t\tthis.setLanguage(languageUniqueToSet);\r\n\t}\r\n\r\n\t#findLanguage(unique: string) {\r\n\t\treturn this.#languages.getValue().find((x) => x.unique === unique);\r\n\t}\r\n\r\n\t#setIsReadOnly() {\r\n\t\tconst appLanguage = this.#appLanguage.getValue();\r\n\r\n\t\tif (!appLanguage) {\r\n\t\t\tthis.appLanguageReadOnlyState.clear();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst unique = this.#readOnlyStateIdentifier + appLanguage.unique;\r\n\t\tthis.appLanguageReadOnlyState.removeState(unique);\r\n\r\n\t\tif (this.#currentUserHasAccessToAllLanguages) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst isReadOnly = !this.#currentUserAllowedLanguages.includes(appLanguage.unique);\r\n\r\n\t\tif (isReadOnly) {\r\n\t\t\tconst readOnlyState = {\r\n\t\t\t\tunique,\r\n\t\t\t\tmessage: 'You do not have permission to edit to this culture',\r\n\t\t\t};\r\n\r\n\t\t\tthis.appLanguageReadOnlyState.addState(readOnlyState);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Default export to enable this as a globalContext extension js:\r\nexport default UmbAppLanguageContext;\r\n"],"names":["UmbAppLanguageContext","UmbContextBase","host","UMB_APP_LANGUAGE_CONTEXT","#languagesPromise","resolve","#languagesResolve","#languages","UmbArrayState","x","y","languages","language","#appLanguage","UmbObjectState","UmbReadOnlyStateManager","#languageCollectionRepository","UmbLanguageCollectionRepository","#currentUserAllowedLanguages","#currentUserHasAccessToAllLanguages","#readOnlyStateIdentifier","#localStorageKey","#variantContext","UmbVariantContext","UMB_AUTH_CONTEXT","authContext","isAuthorized","#requestLanguages","UMB_CURRENT_USER_CONTEXT","context","#setIsReadOnly","hasAccessToAllLanguages","unique","appLanguage","#findLanguage","data","#initAppLanguage","defaultLanguageUnique","uniqueFromLocalStorage","languageFromLocalStorage","languageUniqueToSet","readOnlyState"],"mappings":"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"}