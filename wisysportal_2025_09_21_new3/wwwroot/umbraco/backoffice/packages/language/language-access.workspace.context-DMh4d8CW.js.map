{"version":3,"file":"language-access.workspace.context-DMh4d8CW.js","sources":["../../../src/packages/language/permissions/language-access.workspace.context.ts"],"sourcesContent":["import { UMB_LANGUAGE_ACCESS_WORKSPACE_CONTEXT } from './language-access.workspace.context-token.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { UMB_CURRENT_USER_CONTEXT } from '@umbraco-cms/backoffice/current-user';\r\nimport type { UmbEntityVariantOptionModel, UmbEntityVariantModel } from '@umbraco-cms/backoffice/variant';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport { UMB_CONTENT_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/content';\r\n\r\nexport class UmbLanguageAccessWorkspaceContext extends UmbContextBase {\r\n\t#workspaceContext?: typeof UMB_CONTENT_WORKSPACE_CONTEXT.TYPE;\r\n\t#currentUserAllowedLanguages?: Array<string>;\r\n\t#currentUserHasAccessToAllLanguages?: boolean;\r\n\t#variantOptions?: UmbEntityVariantOptionModel<UmbEntityVariantModel>[];\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_LANGUAGE_ACCESS_WORKSPACE_CONTEXT);\r\n\r\n\t\tthis.consumeContext(UMB_CONTENT_WORKSPACE_CONTEXT, (instance) => {\r\n\t\t\tthis.#workspaceContext = instance;\r\n\t\t\tthis.observe(instance?.variantOptions, (variantOptions) => {\r\n\t\t\t\tthis.#variantOptions = variantOptions;\r\n\t\t\t\tthis.#checkForLanguageAccess();\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_CURRENT_USER_CONTEXT, (context) => {\r\n\t\t\tthis.observe(context?.languages, (languages) => {\r\n\t\t\t\tthis.#currentUserAllowedLanguages = languages;\r\n\t\t\t\tthis.#checkForLanguageAccess();\r\n\t\t\t});\r\n\r\n\t\t\tthis.observe(context?.hasAccessToAllLanguages, (hasAccessToAllLanguages) => {\r\n\t\t\t\tthis.#currentUserHasAccessToAllLanguages = hasAccessToAllLanguages;\r\n\t\t\t\tthis.#checkForLanguageAccess();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tasync #checkForLanguageAccess() {\r\n\t\tif (!this.#workspaceContext) return;\r\n\r\n\t\t// find all disallowed languages\r\n\t\tconst disallowedLanguages = this.#variantOptions?.filter((variant) => {\r\n\t\t\tif (this.#currentUserHasAccessToAllLanguages) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\r\n\t\t\tif (!variant.culture) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\r\n\t\t\treturn !this.#currentUserAllowedLanguages?.includes(variant.culture);\r\n\t\t});\r\n\r\n\t\t// create a list of variantIds for the disallowed languages\r\n\t\tconst variantIds = disallowedLanguages?.map((variant) => new UmbVariantId(variant.culture, variant.segment)) || [];\r\n\r\n\t\t// create a list of states for the disallowed languages\r\n\t\tconst identifier = 'UMB_LANGUAGE_PERMISSION_';\r\n\t\tconst readOnlyRules = variantIds.map((variantId) => {\r\n\t\t\treturn {\r\n\t\t\t\tunique: identifier + variantId.culture,\r\n\t\t\t\tvariantId,\r\n\t\t\t\tmessage: 'You do not have permission to edit to this culture',\r\n\t\t\t};\r\n\t\t});\r\n\r\n\t\t// remove all previous states before adding new ones\r\n\t\t// TODO: But maybe options that was added previously is not there any longer? [NL]\r\n\t\tconst uniques = this.#variantOptions?.map((variant) => identifier + variant.culture) || [];\r\n\t\tthis.#workspaceContext.readOnlyGuard?.removeRules(uniques);\r\n\r\n\t\t// add new states\r\n\t\tthis.#workspaceContext.readOnlyGuard?.addRules(readOnlyRules);\r\n\t}\r\n}\r\n\r\nexport { UmbLanguageAccessWorkspaceContext as api };\r\n"],"names":["UmbLanguageAccessWorkspaceContext","UmbContextBase","#workspaceContext","#currentUserAllowedLanguages","#currentUserHasAccessToAllLanguages","#variantOptions","host","UMB_LANGUAGE_ACCESS_WORKSPACE_CONTEXT","UMB_CONTENT_WORKSPACE_CONTEXT","instance","variantOptions","#checkForLanguageAccess","UMB_CURRENT_USER_CONTEXT","context","languages","hasAccessToAllLanguages","variantIds","variant","UmbVariantId","identifier","readOnlyRules","variantId","uniques"],"mappings":";;;;;AAQO,MAAMA,UAA0CC,EAAe;AAAA,EACrEC;AAAA,EACAC;AAAA,EACAC;AAAA,EACAC;AAAA,EAEA,YAAYC,GAAyB;AACpC,UAAMA,GAAMC,CAAqC,GAE5C,KAAA,eAAeC,GAA+B,CAACC,MAAa;AAChE,WAAKP,KAAoBO,GACzB,KAAK,QAAQA,GAAU,gBAAgB,CAACC,MAAmB;AAC1D,aAAKL,KAAkBK,GACvB,KAAKC,GAAwB;AAAA,MAAA,CAC7B;AAAA,IAAA,CACD,GAEI,KAAA,eAAeC,GAA0B,CAACC,MAAY;AAC1D,WAAK,QAAQA,GAAS,WAAW,CAACC,MAAc;AAC/C,aAAKX,KAA+BW,GACpC,KAAKH,GAAwB;AAAA,MAAA,CAC7B,GAED,KAAK,QAAQE,GAAS,yBAAyB,CAACE,MAA4B;AAC3E,aAAKX,KAAsCW,GAC3C,KAAKJ,GAAwB;AAAA,MAAA,CAC7B;AAAA,IAAA,CACD;AAAA,EAAA;AAAA,EAGF,MAAMA,KAA0B;AAC3B,QAAA,CAAC,KAAKT,GAAmB;AAgB7B,UAAMc,IAbsB,KAAKX,IAAiB,OAAO,CAACY,MACrD,KAAKb,MAIL,CAACa,EAAQ,UACL,KAGD,CAAC,KAAKd,IAA8B,SAASc,EAAQ,OAAO,CACnE,GAGuC,IAAI,CAACA,MAAY,IAAIC,EAAaD,EAAQ,SAASA,EAAQ,OAAO,CAAC,KAAK,CAAC,GAG3GE,IAAa,4BACbC,IAAgBJ,EAAW,IAAI,CAACK,OAC9B;AAAA,MACN,QAAQF,IAAaE,EAAU;AAAA,MAC/B,WAAAA;AAAA,MACA,SAAS;AAAA,IACV,EACA,GAIKC,IAAU,KAAKjB,IAAiB,IAAI,CAACY,MAAYE,IAAaF,EAAQ,OAAO,KAAK,CAAC;AACpF,SAAAf,GAAkB,eAAe,YAAYoB,CAAO,GAGpD,KAAApB,GAAkB,eAAe,SAASkB,CAAa;AAAA,EAAA;AAE9D;"}