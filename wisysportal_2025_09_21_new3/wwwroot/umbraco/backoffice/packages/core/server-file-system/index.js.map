{"version":3,"file":"index.js","sources":["../../../../src/packages/core/server-file-system/append-file-extension.function.ts","../../../../src/packages/core/server-file-system/server-path-unique-serializer.ts","../../../../src/packages/core/server-file-system/rename/rename-server-file-repository-base.ts","../../../../src/packages/core/server-file-system/rename/workspace-redirect/workspace-redirect.controller.ts"],"sourcesContent":["export const appendFileExtensionIfNeeded = (fileName: string, extension: string) => {\r\n\tif (!fileName.endsWith(extension)) {\r\n\t\treturn fileName + extension;\r\n\t}\r\n\r\n\treturn fileName;\r\n};\r\n","export class UmbServerFilePathUniqueSerializer {\r\n\t#magicDot = '%dot%';\r\n\r\n\t/**\r\n\t * Converts a server file path to a unique URL friendly string that can be used in the client\r\n\t * @param {string} serverFilePath\r\n\t * @returns {*}  {(string | null)}\r\n\t * @memberof UmbServerFilePathSerializer\r\n\t */\r\n\ttoUnique(serverFilePath: string): string {\r\n\t\tconst urlSafeServerFilePath = serverFilePath?.replace('.', this.#magicDot);\r\n\t\treturn encodeURIComponent(urlSafeServerFilePath);\r\n\t}\r\n\r\n\t/**\r\n\t * Converts a unique URL friendly string to a server path\r\n\t * @param {string} serverFilePathUnique\r\n\t * @returns {*}  {(string | null)}\r\n\t * @memberof UmbServerFilePathSerializer\r\n\t */\r\n\ttoServerPath(serverFilePathUnique: string | null): string | null {\r\n\t\tif (serverFilePathUnique === undefined) throw new Error('Server file path unique is missing');\r\n\t\tif (serverFilePathUnique === null) return null;\r\n\t\tconst decoded = decodeURIComponent(serverFilePathUnique);\r\n\t\treturn decoded.replace(this.#magicDot, '.');\r\n\t}\r\n}\r\n","import type { UmbRenameServerFileDataSource, UmbRenameServerFileDataSourceConstructor } from './types.js';\r\nimport type { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbDetailStore } from '@umbraco-cms/backoffice/store';\r\nimport { UmbRepositoryBase } from '@umbraco-cms/backoffice/repository';\r\nimport type { UmbEntityModel } from '@umbraco-cms/backoffice/entity';\r\n\r\nexport abstract class UmbRenameServerFileRepositoryBase<\r\n\tDetailModelType extends UmbEntityModel,\r\n> extends UmbRepositoryBase {\r\n\t#renameSource: UmbRenameServerFileDataSource<DetailModelType>;\r\n\t#detailStoreContextAlias: string | UmbContextToken<UmbDetailStore<DetailModelType>>;\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\tdetailSource: UmbRenameServerFileDataSourceConstructor<DetailModelType>,\r\n\t\tdetailStoreContextAlias: string | UmbContextToken<UmbDetailStore<DetailModelType>>,\r\n\t) {\r\n\t\tsuper(host);\r\n\t\tthis.#renameSource = new detailSource(host);\r\n\t\tthis.#detailStoreContextAlias = detailStoreContextAlias;\r\n\t}\r\n\r\n\t/**\r\n\t * Rename\r\n\t * @param {string} unique\r\n\t * @param {string} name\r\n\t * @returns {*}\r\n\t * @memberof UmbRenameServerFileRepositoryBase\r\n\t */\r\n\tasync rename(unique: string, name: string) {\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\t\tif (!name) throw new Error('Name is missing');\r\n\r\n\t\tconst { data, error } = await this.#renameSource.rename(unique, name);\r\n\r\n\t\tif (data) {\r\n\t\t\tconst detailStore = await this.getContext(this.#detailStoreContextAlias);\r\n\t\t\tif (!detailStore) throw new Error('Detail store is missing');\r\n\r\n\t\t\t/* When renaming a file the unique changed because it is based on the path/name\r\n\t\t\tWe need to remove the old item and append the new item */\r\n\t\t\tdetailStore.removeItem(unique);\r\n\t\t\tdetailStore.append(data);\r\n\t\t}\r\n\r\n\t\treturn { data, error };\r\n\t}\r\n}\r\n","import { UmbServerFileRenamedEntityEvent } from '../event/index.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbRouterSlotElement } from '@umbraco-cms/backoffice/router';\r\nimport { ensurePathEndsWithSlash, umbUrlPatternToString } from '@umbraco-cms/backoffice/utils';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport type { UmbSubmittableWorkspaceContextBase } from '@umbraco-cms/backoffice/workspace';\r\n\r\nexport const UmbServerFileRenameWorkspaceRedirectControllerAlias = Symbol(\r\n\t'ServerFileRenameWorkspaceRedirectControllerAlias',\r\n);\r\n\r\nexport class UmbServerFileRenameWorkspaceRedirectController extends UmbControllerBase {\r\n\t#actionEventContext?: typeof UMB_ACTION_EVENT_CONTEXT.TYPE;\r\n\t#workspaceContext: UmbSubmittableWorkspaceContextBase<unknown>;\r\n\t#router: UmbRouterSlotElement;\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\tworkspaceContext: UmbSubmittableWorkspaceContextBase<unknown>,\r\n\t\trouter: UmbRouterSlotElement,\r\n\t) {\r\n\t\tsuper(host, UmbServerFileRenameWorkspaceRedirectControllerAlias);\r\n\r\n\t\tthis.#workspaceContext = workspaceContext;\r\n\t\tthis.#router = router;\r\n\r\n\t\tthis.consumeContext(UMB_ACTION_EVENT_CONTEXT, (context) => {\r\n\t\t\tthis.#actionEventContext = context;\r\n\r\n\t\t\tif (this.#actionEventContext) {\r\n\t\t\t\tthis.#actionEventContext.removeEventListener(UmbServerFileRenamedEntityEvent.TYPE, this.#onFileRenamed);\r\n\t\t\t\tthis.#actionEventContext.addEventListener(UmbServerFileRenamedEntityEvent.TYPE, this.#onFileRenamed);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t#onFileRenamed = ((event: UmbServerFileRenamedEntityEvent) => {\r\n\t\tif (!this.#router) throw new Error('Router is required for this controller.');\r\n\r\n\t\t// Don't redirect if the event is not for the current entity\r\n\t\tconst currentUnique = this.#workspaceContext.getUnique();\r\n\t\tconst eventUnique = event.getUnique();\r\n\t\tif (currentUnique !== eventUnique) return;\r\n\r\n\t\tconst newUnique = event.getNewUnique();\r\n\t\tif (!newUnique) throw new Error('New unique is required for this event.');\r\n\r\n\t\tconst routerPath = this.#router.absoluteRouterPath;\r\n\t\tif (!routerPath) throw new Error('Router path is required for this controller.');\r\n\r\n\t\tconst newPath: string = umbUrlPatternToString(ensurePathEndsWithSlash(routerPath) + 'edit/:unique', {\r\n\t\t\tunique: newUnique,\r\n\t\t});\r\n\r\n\t\tthis.destroy();\r\n\t\twindow.history.replaceState(null, '', newPath);\r\n\t}) as EventListener;\r\n\r\n\tpublic override destroy(): void {\r\n\t\tsuper.destroy();\r\n\t\tthis.#actionEventContext?.removeEventListener(UmbServerFileRenamedEntityEvent.TYPE, this.#onFileRenamed);\r\n\t}\r\n}\r\n"],"names":["appendFileExtensionIfNeeded","fileName","extension","UmbServerFilePathUniqueSerializer","#magicDot","serverFilePath","urlSafeServerFilePath","serverFilePathUnique","UmbRenameServerFileRepositoryBase","UmbRepositoryBase","#renameSource","#detailStoreContextAlias","host","detailSource","detailStoreContextAlias","unique","name","data","error","detailStore","UmbServerFileRenameWorkspaceRedirectControllerAlias","UmbServerFileRenameWorkspaceRedirectController","UmbControllerBase","#actionEventContext","#workspaceContext","#router","workspaceContext","router","UMB_ACTION_EVENT_CONTEXT","context","UmbServerFileRenamedEntityEvent","#onFileRenamed","event","currentUnique","eventUnique","newUnique","routerPath","newPath","umbUrlPatternToString","ensurePathEndsWithSlash"],"mappings":";;;;;;;AAAa,MAAAA,IAA8B,CAACC,GAAkBC,MACxDD,EAAS,SAASC,CAAS,IAIzBD,IAHCA,IAAWC;ACFb,MAAMC,EAAkC;AAAA,EAC9CC,KAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQZ,SAASC,GAAgC;AACxC,UAAMC,IAAwBD,GAAgB,QAAQ,KAAK,KAAKD,EAAS;AACzE,WAAO,mBAAmBE,CAAqB;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAShD,aAAaC,GAAoD;AAChE,QAAIA,MAAyB,OAAiB,OAAA,IAAI,MAAM,oCAAoC;AACxF,WAAAA,MAAyB,OAAa,OAC1B,mBAAmBA,CAAoB,EACxC,QAAQ,KAAKH,IAAW,GAAG;AAAA,EAAA;AAE5C;ACnBO,MAAeI,UAEZC,EAAkB;AAAA,EAC3BC;AAAA,EACAC;AAAA,EAEA,YACCC,GACAC,GACAC,GACC;AACD,UAAMF,CAAI,GACL,KAAAF,KAAgB,IAAIG,EAAaD,CAAI,GAC1C,KAAKD,KAA2BG;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUjC,MAAM,OAAOC,GAAgBC,GAAc;AAC1C,QAAI,CAACD,EAAc,OAAA,IAAI,MAAM,mBAAmB;AAChD,QAAI,CAACC,EAAY,OAAA,IAAI,MAAM,iBAAiB;AAEtC,UAAA,EAAE,MAAAC,GAAM,OAAAC,MAAU,MAAM,KAAKR,GAAc,OAAOK,GAAQC,CAAI;AAEpE,QAAIC,GAAM;AACT,YAAME,IAAc,MAAM,KAAK,WAAW,KAAKR,EAAwB;AACvE,UAAI,CAACQ,EAAmB,OAAA,IAAI,MAAM,yBAAyB;AAI3D,MAAAA,EAAY,WAAWJ,CAAM,GAC7BI,EAAY,OAAOF,CAAI;AAAA,IAAA;AAGjB,WAAA,EAAE,MAAAA,GAAM,OAAAC,EAAM;AAAA,EAAA;AAEvB;ACxCO,MAAME,IAAsD;AAAA,EAClE;AACD;AAEO,MAAMC,UAAuDC,EAAkB;AAAA,EACrFC;AAAA,EACAC;AAAA,EACAC;AAAA,EAEA,YACCb,GACAc,GACAC,GACC;AACD,UAAMf,GAAMQ,CAAmD,GAE/D,KAAKI,KAAoBE,GACzB,KAAKD,KAAUE,GAEV,KAAA,eAAeC,GAA0B,CAACC,MAAY;AAC1D,WAAKN,KAAsBM,GAEvB,KAAKN,OACR,KAAKA,GAAoB,oBAAoBO,EAAgC,MAAM,KAAKC,EAAc,GACtG,KAAKR,GAAoB,iBAAiBO,EAAgC,MAAM,KAAKC,EAAc;AAAA,IACpG,CACA;AAAA,EAAA;AAAA,EAGFA,KAAkB,CAACC,MAA2C;AAC7D,QAAI,CAAC,KAAKP,GAAe,OAAA,IAAI,MAAM,yCAAyC;AAGtE,UAAAQ,IAAgB,KAAKT,GAAkB,UAAU,GACjDU,IAAcF,EAAM,UAAU;AACpC,QAAIC,MAAkBC,EAAa;AAE7B,UAAAC,IAAYH,EAAM,aAAa;AACrC,QAAI,CAACG,EAAiB,OAAA,IAAI,MAAM,wCAAwC;AAElE,UAAAC,IAAa,KAAKX,GAAQ;AAChC,QAAI,CAACW,EAAkB,OAAA,IAAI,MAAM,8CAA8C;AAE/E,UAAMC,IAAkBC,EAAsBC,EAAwBH,CAAU,IAAI,gBAAgB;AAAA,MACnG,QAAQD;AAAA,IAAA,CACR;AAED,SAAK,QAAQ,GACb,OAAO,QAAQ,aAAa,MAAM,IAAIE,CAAO;AAAA,EAC9C;AAAA,EAEgB,UAAgB;AAC/B,UAAM,QAAQ,GACd,KAAKd,IAAqB,oBAAoBO,EAAgC,MAAM,KAAKC,EAAc;AAAA,EAAA;AAEzG;"}