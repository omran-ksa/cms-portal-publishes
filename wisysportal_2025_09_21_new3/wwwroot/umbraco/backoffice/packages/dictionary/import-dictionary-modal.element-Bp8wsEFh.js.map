{"version":3,"file":"import-dictionary-modal.element-Bp8wsEFh.js","sources":["../../../src/packages/dictionary/entity-action/import/import-dictionary-modal.element.ts"],"sourcesContent":["import { UmbDictionaryImportRepository } from '../../repository/index.js';\r\nimport type { UmbImportDictionaryModalData, UmbImportDictionaryModalValue } from './import-dictionary-modal.token.js';\r\nimport { css, html, customElement, query, state, when } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\nimport { UmbModalBaseElement } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbId } from '@umbraco-cms/backoffice/id';\r\nimport type { UmbTreeSelectionConfiguration } from '@umbraco-cms/backoffice/tree';\r\nimport { TemporaryFileStatus, UmbTemporaryFileManager } from '@umbraco-cms/backoffice/temporary-file';\r\nimport type { UUIButtonState } from '@umbraco-cms/backoffice/external/uui';\r\n\r\ninterface UmbDictionaryItemPreview {\r\n\tid: string;\r\n\tname: string;\r\n\tchildren: Array<UmbDictionaryItemPreview>;\r\n}\r\n\r\n@customElement('umb-import-dictionary-modal')\r\nexport class UmbImportDictionaryModalLayout extends UmbModalBaseElement<\r\n\tUmbImportDictionaryModalData,\r\n\tUmbImportDictionaryModalValue\r\n> {\r\n\t@state()\r\n\tprivate _selectionConfiguration: UmbTreeSelectionConfiguration = {\r\n\t\tmultiple: false,\r\n\t\tselectable: true,\r\n\t\tselection: [],\r\n\t};\r\n\r\n\t@state()\r\n\tprivate _parentUnique: string | null = null;\r\n\r\n\t@state()\r\n\tprivate _temporaryFileId = '';\r\n\r\n\t@state()\r\n\tprivate _importButtonState?: UUIButtonState;\r\n\r\n\t@state()\r\n\tprivate _importAllowed = false;\r\n\r\n\t@query('#form')\r\n\tprivate _form!: HTMLFormElement;\r\n\r\n\t#fileReader;\r\n\t#fileContent: Array<UmbDictionaryItemPreview> = [];\r\n\t#dictionaryImportRepository = new UmbDictionaryImportRepository(this);\r\n\t#temporaryFileManager = new UmbTemporaryFileManager(this);\r\n\t#abortController?: AbortController;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.#fileReader = new FileReader();\r\n\r\n\t\tthis.#fileReader.onload = (e) => {\r\n\t\t\tif (typeof e.target?.result === 'string') {\r\n\t\t\t\tconst fileContent = e.target.result;\r\n\t\t\t\tthis.#dictionaryPreviewBuilder(fileContent);\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\toverride connectedCallback(): void {\r\n\t\tsuper.connectedCallback();\r\n\t\tthis._parentUnique = this.data?.unique ?? null;\r\n\t\tthis._selectionConfiguration.selection = this._parentUnique ? [this._parentUnique] : [];\r\n\t}\r\n\r\n\tasync #submit() {\r\n\t\tconst { error } = await this.#dictionaryImportRepository.requestImport(this._temporaryFileId, this._parentUnique);\r\n\t\tif (error) return;\r\n\r\n\t\tthis._submitModal();\r\n\t}\r\n\r\n\t#dictionaryPreviewBuilder(htmlString: string) {\r\n\t\tconst parser = new DOMParser();\r\n\t\tconst doc = parser.parseFromString(htmlString, 'text/xml');\r\n\t\tconst elements = doc.childNodes;\r\n\r\n\t\tthis.#fileContent = this.#dictionaryPreviewItemBuilder(elements);\r\n\t\tthis.requestUpdate();\r\n\t}\r\n\r\n\t#dictionaryPreviewItemBuilder(nodeList: NodeListOf<ChildNode>): Array<UmbDictionaryItemPreview> {\r\n\t\tconst items: Array<UmbDictionaryItemPreview> = [];\r\n\t\tconst list: Array<Element> = [];\r\n\t\tnodeList.forEach((node) => {\r\n\t\t\tif (node.nodeType === Node.ELEMENT_NODE && node.nodeName === 'DictionaryItem') {\r\n\t\t\t\tlist.push(node as Element);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tlist.forEach((item) => {\r\n\t\t\titems.push({\r\n\t\t\t\tname: item.getAttribute('Name') ?? '',\r\n\t\t\t\tid: item.getAttribute('Key') ?? '',\r\n\t\t\t\tchildren: this.#dictionaryPreviewItemBuilder(item.childNodes) ?? undefined,\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\treturn items;\r\n\t}\r\n\r\n\tasync #onUpload(e: Event) {\r\n\t\te.preventDefault();\r\n\r\n\t\tthis.#onClear();\r\n\r\n\t\tconst formData = new FormData(this._form);\r\n\t\tconst file = formData.get('file') as File;\r\n\t\tif (!file) throw new Error('File is missing');\r\n\r\n\t\tthis.#fileReader.readAsText(file);\r\n\t\tconst temporaryUnique = UmbId.new();\r\n\r\n\t\tthis.#abortController = new AbortController();\r\n\r\n\t\tconst { status } = await this.#temporaryFileManager.uploadOne({\r\n\t\t\tfile,\r\n\t\t\ttemporaryUnique,\r\n\t\t\tabortController: this.#abortController,\r\n\t\t});\r\n\r\n\t\tif (status === TemporaryFileStatus.SUCCESS) {\r\n\t\t\tthis._importAllowed = true;\r\n\t\t\tthis._temporaryFileId = temporaryUnique;\r\n\t\t}\r\n\t}\r\n\r\n\tasync #onFileInput() {\r\n\t\trequestAnimationFrame(() => {\r\n\t\t\tthis._form.requestSubmit();\r\n\t\t});\r\n\t}\r\n\r\n\t#onClear() {\r\n\t\tthis._temporaryFileId = '';\r\n\t\tthis._importAllowed = false;\r\n\t\tthis.#abortController?.abort();\r\n\t\tthis.#abortController = undefined;\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn html` <umb-body-layout headline=${this.localize.term('general_import')}>\r\n\t\t\t<uui-box>\r\n\t\t\t\t${when(\r\n\t\t\t\t\tthis._temporaryFileId,\r\n\t\t\t\t\t() => this.#renderImportDestination(),\r\n\t\t\t\t\t() => this.#renderUploadZone(),\r\n\t\t\t\t)}\r\n\t\t\t</uui-box>\r\n\t\t\t<uui-button\r\n\t\t\t\tslot=\"actions\"\r\n\t\t\t\ttype=\"button\"\r\n\t\t\t\tlabel=${this.localize.term('general_cancel')}\r\n\t\t\t\t@click=${this._rejectModal}></uui-button>\r\n\t\t</umb-body-layout>`;\r\n\t}\r\n\r\n\t#renderFileContents(items: Array<UmbDictionaryItemPreview>): any {\r\n\t\treturn html`${items.map((item: UmbDictionaryItemPreview) => {\r\n\t\t\treturn html`${item.name}\r\n\t\t\t\t<div>${this.#renderFileContents(item.children)}</div>`;\r\n\t\t})}`;\r\n\t}\r\n\r\n\t#renderImportDestination() {\r\n\t\treturn html`\r\n\t\t\t<div id=\"wrapper\">\r\n\t\t\t\t<div>\r\n\t\t\t\t\t<strong><umb-localize key=\"visuallyHiddenTexts_dictionaryItems\">Dictionary items</umb-localize>:</strong>\r\n\t\t\t\t\t<div id=\"item-list\">${this.#renderFileContents(this.#fileContent)}</div>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t${this.#renderNavigate()}\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderNavigate() {\r\n\t\treturn html`<div id=\"nav\">\r\n\t\t\t<uui-button label=${this.localize.term('general_import')} look=\"secondary\" @click=${this.#onClear}>\r\n\t\t\t\t<uui-icon name=\"icon-arrow-left\"></uui-icon>\r\n\t\t\t\t${this.localize.term('general_back')}\r\n\t\t\t</uui-button>\r\n\t\t\t<uui-button\r\n\t\t\t\t.state=${this._importButtonState}\r\n\t\t\t\t?disabled=${!this._importAllowed}\r\n\t\t\t\ttype=\"button\"\r\n\t\t\t\tlabel=${this.localize.term('general_import')}\r\n\t\t\t\tlook=\"primary\"\r\n\t\t\t\t@click=${this.#submit}></uui-button>\r\n\t\t</div>`;\r\n\t}\r\n\r\n\t#renderUploadZone() {\r\n\t\treturn html`<umb-localize key=\"dictionary_importDictionaryItemHelp\"></umb-localize>\r\n\t\t\t<uui-form>\r\n\t\t\t\t<form id=\"form\" name=\"form\" @submit=${this.#onUpload}>\r\n\t\t\t\t\t<uui-form-layout-item>\r\n\t\t\t\t\t\t<uui-label for=\"file\" slot=\"label\" required>${this.localize.term('dictionary_pickFile')}</uui-label>\r\n\t\t\t\t\t\t<uui-input-file\r\n\t\t\t\t\t\t\taccept=\".udt\"\r\n\t\t\t\t\t\t\tname=\"file\"\r\n\t\t\t\t\t\t\tid=\"file\"\r\n\t\t\t\t\t\t\t@input=${this.#onFileInput}\r\n\t\t\t\t\t\t\trequired\r\n\t\t\t\t\t\t\trequired-message=${this.localize.term('dictionary_pickFileRequired')}></uui-input-file>\r\n\t\t\t\t\t</uui-form-layout-item>\r\n\t\t\t\t</form>\r\n\t\t\t</uui-form>`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\tcss`\r\n\t\t\tuui-input {\r\n\t\t\t\twidth: 100%;\r\n\t\t\t}\r\n\t\t\t#item-list {\r\n\t\t\t\tpadding: var(--uui-size-3) var(--uui-size-4);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t}\r\n\t\t\t#item-list div {\r\n\t\t\t\tpadding-left: 20px;\r\n\t\t\t}\r\n\r\n\t\t\t#wrapper {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-3);\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UmbImportDictionaryModalLayout;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-import-dictionary-modal': UmbImportDictionaryModalLayout;\r\n\t}\r\n}\r\n"],"names":["_fileReader","_fileContent","_dictionaryImportRepository","_temporaryFileManager","_abortController","_UmbImportDictionaryModalLayout_instances","submit_fn","dictionaryPreviewBuilder_fn","dictionaryPreviewItemBuilder_fn","onUpload_fn","onFileInput_fn","onClear_fn","renderFileContents_fn","renderImportDestination_fn","renderNavigate_fn","renderUploadZone_fn","UmbImportDictionaryModalLayout","UmbModalBaseElement","__privateAdd","UmbDictionaryImportRepository","UmbTemporaryFileManager","__privateSet","__privateGet","e","fileContent","__privateMethod","html","when","error","htmlString","elements","nodeList","items","list","node","item","file","temporaryUnique","UmbId","status","TemporaryFileStatus","UmbTextStyles","css","__decorateClass","state","query","customElement","UmbImportDictionaryModalLayout$1"],"mappings":"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"}