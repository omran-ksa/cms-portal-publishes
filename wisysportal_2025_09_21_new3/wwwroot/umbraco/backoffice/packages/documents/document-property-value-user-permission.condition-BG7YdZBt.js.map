{"version":3,"file":"document-property-value-user-permission.condition-BG7YdZBt.js","sources":["../../../src/packages/documents/documents/user-permissions/document-property-value/conditions/utils.ts","../../../src/packages/documents/documents/user-permissions/document-property-value/conditions/document-property-value-user-permission.condition.ts"],"sourcesContent":["import type { UmbDocumentPropertyValueUserPermissionModel } from '../types.js';\r\nimport { UMB_DOCUMENT_PROPERTY_VALUE_USER_PERMISSION_TYPE } from '../user-permission.js';\r\n\r\n/**\r\n *\r\n * @param permission\r\n * @returns {boolean} True if the permission is a permission for document property values\r\n */\r\nexport function isDocumentPropertyValueUserPermission(\r\n\tpermission: unknown,\r\n): permission is UmbDocumentPropertyValueUserPermissionModel {\r\n\treturn (\r\n\t\t(permission as UmbDocumentPropertyValueUserPermissionModel).userPermissionType ===\r\n\t\tUMB_DOCUMENT_PROPERTY_VALUE_USER_PERMISSION_TYPE\r\n\t);\r\n}\r\n","import type { UmbDocumentPropertyValueUserPermissionModel } from '../types.js';\r\nimport type { UmbDocumentPropertyValueUserPermissionConditionConfig } from './types.js';\r\nimport { isDocumentPropertyValueUserPermission } from './utils.js';\r\nimport { UMB_CURRENT_USER_CONTEXT } from '@umbraco-cms/backoffice/current-user';\r\nimport type { UmbConditionControllerArguments, UmbExtensionCondition } from '@umbraco-cms/backoffice/extension-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbConditionBase } from '@umbraco-cms/backoffice/extension-registry';\r\n\r\nexport class UmbDocumentPropertyValueUserPermissionCondition\r\n\textends UmbConditionBase<UmbDocumentPropertyValueUserPermissionConditionConfig>\r\n\timplements UmbExtensionCondition\r\n{\r\n\t#documentPropertyValuePermissions: Array<UmbDocumentPropertyValueUserPermissionModel> = [];\r\n\t#fallbackPermissions: string[] = [];\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\targs: UmbConditionControllerArguments<UmbDocumentPropertyValueUserPermissionConditionConfig>,\r\n\t) {\r\n\t\tsuper(host, args);\r\n\r\n\t\tthis.consumeContext(UMB_CURRENT_USER_CONTEXT, (context) => {\r\n\t\t\tthis.observe(\r\n\t\t\t\tcontext?.currentUser,\r\n\t\t\t\t(currentUser) => {\r\n\t\t\t\t\tthis.#documentPropertyValuePermissions =\r\n\t\t\t\t\t\tcurrentUser?.permissions?.filter(isDocumentPropertyValueUserPermission) || [];\r\n\t\t\t\t\tthis.#fallbackPermissions = currentUser?.fallbackPermissions || [];\r\n\t\t\t\t\tthis.#checkPermissions();\r\n\t\t\t\t},\r\n\t\t\t\t'umbDocumentPropertyValueUserPermissionConditionObserver',\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\t#checkPermissions() {\r\n\t\tconst hasDocumentPropertyValuePermissions = this.#documentPropertyValuePermissions.length > 0;\r\n\r\n\t\t// if there is no permissions for any documents we use the fallback permissions\r\n\t\tif (!hasDocumentPropertyValuePermissions) {\r\n\t\t\tthis.#check(this.#fallbackPermissions);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t/* If there are document permission we check if there are permissions for the current document property value\r\n\t\t If there aren't we use the fallback permissions */\r\n\t\tif (hasDocumentPropertyValuePermissions) {\r\n\t\t\tconst permissionsForCurrentDocumentPropertyValue = this.#documentPropertyValuePermissions.find(\r\n\t\t\t\t(permission) => permission.propertyType.unique === this.config.match.propertyType.unique,\r\n\t\t\t);\r\n\r\n\t\t\t// no permissions for the current document property value - use the fallback permissions\r\n\t\t\tif (!permissionsForCurrentDocumentPropertyValue) {\r\n\t\t\t\tthis.#check(this.#fallbackPermissions);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// we found permissions for the current document property value - check them\r\n\t\t\tthis.#check(permissionsForCurrentDocumentPropertyValue.verbs);\r\n\t\t}\r\n\t}\r\n\r\n\t#check(verbs: Array<string>) {\r\n\t\t/* we default to true se we don't require both allOf and oneOf to be defined\r\n\t\t but they can be combined for more complex scenarios */\r\n\t\tlet allOfPermitted = true;\r\n\t\tlet oneOfPermitted = true;\r\n\r\n\t\t// check if all of the verbs are present\r\n\t\tif (this.config.allOf?.length) {\r\n\t\t\tallOfPermitted = this.config.allOf.every((verb) => verbs.includes(verb));\r\n\t\t}\r\n\r\n\t\t// check if at least one of the verbs is present\r\n\t\tif (this.config.oneOf?.length) {\r\n\t\t\toneOfPermitted = this.config.oneOf.some((verb) => verbs.includes(verb));\r\n\t\t}\r\n\r\n\t\t// if neither allOf or oneOf is defined we default to false\r\n\t\tif (!allOfPermitted && !oneOfPermitted) {\r\n\t\t\tallOfPermitted = false;\r\n\t\t\toneOfPermitted = false;\r\n\t\t}\r\n\r\n\t\tthis.permitted = allOfPermitted && oneOfPermitted;\r\n\t}\r\n}\r\n\r\nexport { UmbDocumentPropertyValueUserPermissionCondition as api };\r\n"],"names":["isDocumentPropertyValueUserPermission","permission","UMB_DOCUMENT_PROPERTY_VALUE_USER_PERMISSION_TYPE","UmbDocumentPropertyValueUserPermissionCondition","UmbConditionBase","#documentPropertyValuePermissions","#fallbackPermissions","host","args","UMB_CURRENT_USER_CONTEXT","context","currentUser","#checkPermissions","hasDocumentPropertyValuePermissions","#check","permissionsForCurrentDocumentPropertyValue","verbs","allOfPermitted","oneOfPermitted","verb"],"mappings":";;;AAQO,SAASA,EACfC,GAC4D;AAC5D,SACEA,EAA2D,uBAC5DC;AAEF;ACPO,MAAMC,UACJC,EAET;AAAA,EACCC,KAAwF,CAAC;AAAA,EACzFC,KAAiC,CAAC;AAAA,EAElC,YACCC,GACAC,GACC;AACD,UAAMD,GAAMC,CAAI,GAEX,KAAA,eAAeC,GAA0B,CAACC,MAAY;AACrD,WAAA;AAAA,QACJA,GAAS;AAAA,QACT,CAACC,MAAgB;AAChB,eAAKN,KACJM,GAAa,aAAa,OAAOX,CAAqC,KAAK,CAAC,GACxE,KAAAM,KAAuBK,GAAa,uBAAuB,CAAC,GACjE,KAAKC,GAAkB;AAAA,QACxB;AAAA,QACA;AAAA,MACD;AAAA,IAAA,CACA;AAAA,EAAA;AAAA,EAGFA,KAAoB;AACb,UAAAC,IAAsC,KAAKR,GAAkC,SAAS;AAG5F,QAAI,CAACQ,GAAqC;AACpC,WAAAC,GAAO,KAAKR,EAAoB;AACrC;AAAA,IAAA;AAKD,QAAIO,GAAqC;AAClC,YAAAE,IAA6C,KAAKV,GAAkC;AAAA,QACzF,CAACJ,MAAeA,EAAW,aAAa,WAAW,KAAK,OAAO,MAAM,aAAa;AAAA,MACnF;AAGA,UAAI,CAACc,GAA4C;AAC3C,aAAAD,GAAO,KAAKR,EAAoB;AACrC;AAAA,MAAA;AAII,WAAAQ,GAAOC,EAA2C,KAAK;AAAA,IAAA;AAAA,EAC7D;AAAA,EAGDD,GAAOE,GAAsB;AAG5B,QAAIC,IAAiB,IACjBC,IAAiB;AAGjB,IAAA,KAAK,OAAO,OAAO,WACLD,IAAA,KAAK,OAAO,MAAM,MAAM,CAACE,MAASH,EAAM,SAASG,CAAI,CAAC,IAIpE,KAAK,OAAO,OAAO,WACLD,IAAA,KAAK,OAAO,MAAM,KAAK,CAACC,MAASH,EAAM,SAASG,CAAI,CAAC,IAInE,CAACF,KAAkB,CAACC,MACND,IAAA,IACAC,IAAA,KAGlB,KAAK,YAAYD,KAAkBC;AAAA,EAAA;AAErC;"}