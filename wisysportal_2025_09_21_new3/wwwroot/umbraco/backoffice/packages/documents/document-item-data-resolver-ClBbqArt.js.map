{"version":3,"file":"document-item-data-resolver-ClBbqArt.js","sources":["../../../src/packages/documents/documents/item/document-item-data-resolver.ts"],"sourcesContent":["import { UmbDocumentVariantState } from '../types.js';\r\nimport type { UmbDocumentItemModel } from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { DocumentVariantStateModel } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport { UmbBooleanState, UmbObjectState, UmbStringState } from '@umbraco-cms/backoffice/observable-api';\r\nimport { type UmbVariantContext, UMB_VARIANT_CONTEXT } from '@umbraco-cms/backoffice/variant';\r\n\r\ntype UmbDocumentItemDataResolverModel = Omit<UmbDocumentItemModel, 'parent' | 'hasChildren'>;\r\n\r\n/**\r\n * A controller for resolving data for a document item\r\n * @exports\r\n * @class UmbDocumentItemDataResolver\r\n * @augments {UmbControllerBase}\r\n */\r\nexport class UmbDocumentItemDataResolver<DataType extends UmbDocumentItemDataResolverModel> extends UmbControllerBase {\r\n\t#data = new UmbObjectState<DataType | undefined>(undefined);\r\n\r\n\tpublic readonly unique = this.#data.asObservablePart((x) => x?.unique);\r\n\tpublic readonly icon = this.#data.asObservablePart((x) => x?.documentType.icon);\r\n\tpublic readonly isTrashed = this.#data.asObservablePart((x) => x?.isTrashed);\r\n\r\n\t#name = new UmbStringState(undefined);\r\n\tpublic readonly name = this.#name.asObservable();\r\n\r\n\t#state = new UmbStringState(undefined);\r\n\tpublic readonly state = this.#state.asObservable();\r\n\r\n\t#isDraft = new UmbBooleanState(undefined);\r\n\tpublic readonly isDraft = this.#isDraft.asObservable();\r\n\r\n\t#variantContext?: UmbVariantContext;\r\n\t#fallbackCulture?: string | null;\r\n\t#displayCulture?: string | null;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.consumeContext(UMB_VARIANT_CONTEXT, (context) => {\r\n\t\t\tthis.#variantContext = context;\r\n\t\t\tthis.#observeVariantContext();\r\n\t\t});\r\n\t}\r\n\r\n\t#observeVariantContext() {\r\n\t\tthis.observe(\r\n\t\t\tthis.#variantContext?.displayCulture,\r\n\t\t\t(displayCulture) => {\r\n\t\t\t\tif (displayCulture === undefined) return;\r\n\t\t\t\tthis.#displayCulture = displayCulture;\r\n\t\t\t\tthis.#setVariantAwareValues();\r\n\t\t\t},\r\n\t\t\t'umbObserveVariantId',\r\n\t\t);\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis.#variantContext?.fallbackCulture,\r\n\t\t\t(fallbackCulture) => {\r\n\t\t\t\tif (fallbackCulture === undefined) return;\r\n\t\t\t\tthis.#fallbackCulture = fallbackCulture;\r\n\t\t\t\tthis.#setVariantAwareValues();\r\n\t\t\t},\r\n\t\t\t'umbObserveFallbackCulture',\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * Get the current item\r\n\t * @returns {DataType | undefined} The current item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tgetData(): DataType | undefined {\r\n\t\treturn this.#data.getValue();\r\n\t}\r\n\r\n\t/**\r\n\t * Set the current item\r\n\t * @param {DataType | undefined} data The current item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tsetData(data: DataType | undefined) {\r\n\t\tthis.#data.setValue(data);\r\n\t\tthis.#setVariantAwareValues();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the unique of the item\r\n\t * @returns {Promise<string | undefined>} The unique of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getUnique(): Promise<string | undefined> {\r\n\t\treturn await this.observe(this.unique).asPromise();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the name of the item\r\n\t * @returns {Promise<string>} The name of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getName(): Promise<string> {\r\n\t\treturn (await this.observe(this.name).asPromise()) || '';\r\n\t}\r\n\r\n\t/**\r\n\t * Get the icon of the item\r\n\t * @returns {Promise<string | undefined>} The icon of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getIcon(): Promise<string | undefined> {\r\n\t\treturn await this.observe(this.icon).asPromise();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the state of the item\r\n\t * @returns {Promise<string | undefined>} The state of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getState(): Promise<DocumentVariantStateModel | null | undefined> {\r\n\t\tconst variant = await this.#getCurrentVariant();\r\n\t\treturn variant?.state;\r\n\t}\r\n\r\n\t/**\r\n\t * Get the isDraft of the item\r\n\t * @returns {Promise<boolean>} The isDraft of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getIsDraft(): Promise<boolean> {\r\n\t\treturn (await this.observe(this.isDraft).asPromise()) ?? false;\r\n\t}\r\n\r\n\t/**\r\n\t * Get the isTrashed of the item\r\n\t * @returns {Promise<boolean | undefined>} The isTrashed of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getIsTrashed(): Promise<boolean> {\r\n\t\treturn (await this.observe(this.isTrashed).asPromise()) ?? false;\r\n\t}\r\n\r\n\t#setVariantAwareValues() {\r\n\t\tif (!this.#variantContext) return;\r\n\t\tif (!this.#displayCulture) return;\r\n\t\tif (!this.#fallbackCulture) return;\r\n\t\tif (!this.#data) return;\r\n\t\tthis.#setName();\r\n\t\tthis.#setIsDraft();\r\n\t\tthis.#setState();\r\n\t}\r\n\r\n\tasync #setName() {\r\n\t\tconst variant = await this.#getCurrentVariant();\r\n\t\tif (variant) {\r\n\t\t\tthis.#name.setValue(variant.name);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst fallbackName = this.#findVariant(this.#fallbackCulture!)?.name;\r\n\t\tthis.#name.setValue(`(${fallbackName})`);\r\n\t}\r\n\r\n\tasync #setIsDraft() {\r\n\t\tconst variant = await this.#getCurrentVariant();\r\n\t\tconst isDraft = variant?.state === UmbDocumentVariantState.DRAFT || false;\r\n\t\tthis.#isDraft.setValue(isDraft);\r\n\t}\r\n\r\n\tasync #setState() {\r\n\t\tconst variant = await this.#getCurrentVariant();\r\n\t\tconst state = variant?.state || UmbDocumentVariantState.NOT_CREATED;\r\n\t\tthis.#state.setValue(state);\r\n\t}\r\n\r\n\t#findVariant(culture: string | undefined) {\r\n\t\treturn this.getData()?.variants.find((x) => x.culture === culture);\r\n\t}\r\n\r\n\tasync #getCurrentVariant() {\r\n\t\tif (this.#isInvariant()) {\r\n\t\t\treturn this.getData()?.variants?.[0];\r\n\t\t}\r\n\r\n\t\treturn this.#findVariant(this.#displayCulture!);\r\n\t}\r\n\r\n\t#isInvariant() {\r\n\t\treturn this.getData()?.variants?.[0]?.culture === null;\r\n\t}\r\n}\r\n"],"names":["UmbDocumentItemDataResolver","UmbControllerBase","host","#data","UmbObjectState","x","#name","UmbStringState","#state","#isDraft","UmbBooleanState","UMB_VARIANT_CONTEXT","context","#variantContext","#observeVariantContext","#fallbackCulture","#displayCulture","displayCulture","#setVariantAwareValues","fallbackCulture","data","#getCurrentVariant","#setName","#setIsDraft","#setState","variant","fallbackName","#findVariant","isDraft","UmbDocumentVariantState","state","culture","#isInvariant"],"mappings":"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"}