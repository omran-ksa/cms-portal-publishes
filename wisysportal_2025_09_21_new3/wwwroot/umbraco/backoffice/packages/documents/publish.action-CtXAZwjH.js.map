{"version":3,"file":"publish.action-CtXAZwjH.js","sources":["../../../src/packages/documents/documents/publishing/publish/entity-action/publish.action.ts"],"sourcesContent":["import type { UmbDocumentVariantOptionModel } from '../../../types.js';\r\nimport { UMB_DOCUMENT_PUBLISH_MODAL } from '../modal/constants.js';\r\nimport { UmbDocumentDetailRepository } from '../../../repository/index.js';\r\nimport { UmbDocumentPublishingRepository } from '../../repository/index.js';\r\nimport { UMB_APP_LANGUAGE_CONTEXT, UmbLanguageCollectionRepository } from '@umbraco-cms/backoffice/language';\r\nimport type { UmbEntityActionArgs } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbEntityActionBase, UmbRequestReloadStructureForEntityEvent } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { umbOpenModal } from '@umbraco-cms/backoffice/modal';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport { UMB_CURRENT_USER_CONTEXT } from '@umbraco-cms/backoffice/current-user';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\n\r\nexport class UmbPublishDocumentEntityAction extends UmbEntityActionBase<never> {\r\n\tconstructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n\t\tsuper(host, args);\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tif (!this.args.unique) throw new Error('The document unique identifier is missing');\r\n\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst localize = new UmbLocalizationController(this);\r\n\r\n\t\tconst languageRepository = new UmbLanguageCollectionRepository(this._host);\r\n\t\tconst { data: languageData } = await languageRepository.requestCollection({});\r\n\r\n\t\tconst documentRepository = new UmbDocumentDetailRepository(this._host);\r\n\t\tconst { data: documentData } = await documentRepository.requestByUnique(this.args.unique);\r\n\r\n\t\tif (!documentData) throw new Error('The document was not found');\r\n\r\n\t\tconst appLanguageContext = await this.getContext(UMB_APP_LANGUAGE_CONTEXT);\r\n\t\tif (!appLanguageContext) throw new Error('The app language context is missing');\r\n\t\tconst appCulture = appLanguageContext.getAppCulture();\r\n\r\n\t\tconst currentUserContext = await this.getContext(UMB_CURRENT_USER_CONTEXT);\r\n\t\tif (!currentUserContext) throw new Error('The current user context is missing');\r\n\t\tconst currentUserAllowedLanguages = currentUserContext.getLanguages();\r\n\t\tconst currentUserHasAccessToAllLanguages = currentUserContext.getHasAccessToAllLanguages();\r\n\r\n\t\tif (currentUserAllowedLanguages === undefined) throw new Error('The current user languages are missing');\r\n\t\tif (currentUserHasAccessToAllLanguages === undefined)\r\n\t\t\tthrow new Error('The current user access to all languages is missing');\r\n\r\n\t\tconst options: Array<UmbDocumentVariantOptionModel> = documentData.variants\r\n\t\t\t// only display culture variants as options\r\n\t\t\t.filter((variant) => variant.segment === null)\r\n\t\t\t.map<UmbDocumentVariantOptionModel>((variant) => ({\r\n\t\t\t\tculture: variant.culture,\r\n\t\t\t\tsegment: variant.segment,\r\n\t\t\t\tlanguage: languageData?.items.find((language) => language.unique === variant.culture) ?? {\r\n\t\t\t\t\tname: appCulture!,\r\n\t\t\t\t\tentityType: 'language',\r\n\t\t\t\t\tfallbackIsoCode: null,\r\n\t\t\t\t\tisDefault: true,\r\n\t\t\t\t\tisMandatory: false,\r\n\t\t\t\t\tunique: appCulture!,\r\n\t\t\t\t},\r\n\t\t\t\tvariant,\r\n\t\t\t\tunique: new UmbVariantId(variant.culture, variant.segment).toString(),\r\n\t\t\t}));\r\n\r\n\t\t// Figure out the default selections\r\n\t\t// TODO: Missing features to pre-select the variant that fits with the variant-id of the tree/collection? (Again only relevant if the action is executed from a Tree or Collection) [NL]\r\n\t\tconst selection: Array<string> = [];\r\n\t\t// If the app language is one of the options, select it by default:\r\n\t\tif (appCulture && options.some((o) => o.unique === appCulture)) {\r\n\t\t\tselection.push(new UmbVariantId(appCulture, null).toString());\r\n\t\t} else {\r\n\t\t\t// If not, select the first option by default:\r\n\t\t\tselection.push(options[0].unique);\r\n\t\t}\r\n\r\n\t\tconst result = await umbOpenModal(this, UMB_DOCUMENT_PUBLISH_MODAL, {\r\n\t\t\tdata: {\r\n\t\t\t\tconfirmLabel: '#actions_publish',\r\n\t\t\t\toptions,\r\n\t\t\t\tpickableFilter: (option) => {\r\n\t\t\t\t\tif (!option.culture) return false;\r\n\t\t\t\t\tif (currentUserHasAccessToAllLanguages) return true;\r\n\t\t\t\t\treturn currentUserAllowedLanguages.includes(option.culture);\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tvalue: { selection },\r\n\t\t}).catch(() => undefined);\r\n\r\n\t\tif (!result?.selection.length) return;\r\n\r\n\t\tconst variantIds = result?.selection.map((x) => UmbVariantId.FromString(x)) ?? [];\r\n\r\n\t\t// find all segments of a selected culture\r\n\t\tconst publishableVariantIds = variantIds.flatMap((variantId) =>\r\n\t\t\tdocumentData.variants\r\n\t\t\t\t.filter((variant) => variantId.culture === variant.culture)\r\n\t\t\t\t.map((variant) => UmbVariantId.Create(variant).toSegment(variant.segment)),\r\n\t\t);\r\n\r\n\t\tif (publishableVariantIds.length) {\r\n\t\t\tconst publishingRepository = new UmbDocumentPublishingRepository(this._host);\r\n\t\t\tconst { error } = await publishingRepository.publish(\r\n\t\t\t\tthis.args.unique,\r\n\t\t\t\tpublishableVariantIds.map((variantId) => ({ variantId })),\r\n\t\t\t);\r\n\r\n\t\t\tif (error) {\r\n\t\t\t\tthrow error;\r\n\t\t\t}\r\n\r\n\t\t\tif (!error) {\r\n\t\t\t\t// If the content is invariant, we need to show a different notification\r\n\t\t\t\tconst isInvariant = options.length === 1 && options[0].culture === null;\r\n\r\n\t\t\t\tif (isInvariant) {\r\n\t\t\t\t\tnotificationContext?.peek('positive', {\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\theadline: localize.term('speechBubbles_editContentPublishedHeader'),\r\n\t\t\t\t\t\t\tmessage: localize.term('speechBubbles_editContentPublishedText'),\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst documentVariants = documentData.variants.filter((variant) =>\r\n\t\t\t\t\t\tresult.selection.includes(variant.culture!),\r\n\t\t\t\t\t);\r\n\t\t\t\t\tnotificationContext?.peek('positive', {\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\theadline: localize.term('speechBubbles_editContentPublishedHeader'),\r\n\t\t\t\t\t\t\tmessage: localize.term(\r\n\t\t\t\t\t\t\t\t'speechBubbles_editVariantPublishedText',\r\n\t\t\t\t\t\t\t\t// TODO: show correct variant names instead of variant strings [MR]\r\n\t\t\t\t\t\t\t\tlocalize.list(documentVariants.map((v) => UmbVariantId.Create(v).toString() ?? v.name)),\r\n\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst actionEventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\t\tconst event = new UmbRequestReloadStructureForEntityEvent({\r\n\t\t\t\tunique: this.args.unique,\r\n\t\t\t\tentityType: this.args.entityType,\r\n\t\t\t});\r\n\r\n\t\t\tactionEventContext?.dispatchEvent(event);\r\n\t\t}\r\n\t}\r\n}\r\nexport default UmbPublishDocumentEntityAction;\r\n"],"names":["UmbPublishDocumentEntityAction","UmbEntityActionBase","host","args","notificationContext","UMB_NOTIFICATION_CONTEXT","localize","UmbLocalizationController","languageRepository","UmbLanguageCollectionRepository","languageData","documentRepository","UmbDocumentDetailRepository","documentData","appLanguageContext","UMB_APP_LANGUAGE_CONTEXT","appCulture","currentUserContext","UMB_CURRENT_USER_CONTEXT","currentUserAllowedLanguages","currentUserHasAccessToAllLanguages","options","variant","language","UmbVariantId","selection","o","result","umbOpenModal","UMB_DOCUMENT_PUBLISH_MODAL","option","publishableVariantIds","x","variantId","publishingRepository","UmbDocumentPublishingRepository","error","documentVariants","v","actionEventContext","UMB_ACTION_EVENT_CONTEXT","event","UmbRequestReloadStructureForEntityEvent"],"mappings":"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"}