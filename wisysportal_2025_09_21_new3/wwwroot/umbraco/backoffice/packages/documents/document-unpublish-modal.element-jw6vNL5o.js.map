{"version":3,"file":"document-unpublish-modal.element-jw6vNL5o.js","sources":["../../../src/packages/documents/documents/publishing/unpublish/modal/document-unpublish-modal.element.ts"],"sourcesContent":["import { UmbDocumentVariantState, type UmbDocumentVariantOptionModel } from '../../../types.js';\r\nimport { UMB_DOCUMENT_ITEM_REPOSITORY_ALIAS, UMB_DOCUMENT_REFERENCE_REPOSITORY_ALIAS } from '../../../constants.js';\r\nimport { UMB_DOCUMENT_CONFIGURATION_CONTEXT } from '../../../global-contexts/index.js';\r\nimport type {\r\n\tUmbDocumentUnpublishModalData,\r\n\tUmbDocumentUnpublishModalValue,\r\n} from './document-unpublish-modal.token.js';\r\nimport { css, customElement, html, nothing, state, when } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbModalBaseElement } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\nimport { UmbSelectionManager } from '@umbraco-cms/backoffice/utils';\r\nimport type {\r\n\tUmbConfirmActionModalEntityReferencesConfig,\r\n\tUmbConfirmActionModalEntityReferencesElement,\r\n} from '@umbraco-cms/backoffice/relations';\r\nimport type { UmbChangeEvent } from '@umbraco-cms/backoffice/event';\r\n\r\nimport '../../../modals/shared/document-variant-language-picker.element.js';\r\n\r\n/**\r\n * @function isPublished\r\n * @param {UmbDocumentVariantOptionModel} option - the option to check.\r\n * @returns {boolean} boolean\r\n */\r\nexport function isPublished(option: UmbDocumentVariantOptionModel): boolean {\r\n\treturn (\r\n\t\toption.variant?.state === UmbDocumentVariantState.PUBLISHED ||\r\n\t\toption.variant?.state === UmbDocumentVariantState.PUBLISHED_PENDING_CHANGES\r\n\t);\r\n}\r\n\r\n@customElement('umb-document-unpublish-modal')\r\nexport class UmbDocumentUnpublishModalElement extends UmbModalBaseElement<\r\n\tUmbDocumentUnpublishModalData,\r\n\tUmbDocumentUnpublishModalValue\r\n> {\r\n\tprotected readonly _selectionManager = new UmbSelectionManager<string>(this);\r\n\r\n\t@state()\r\n\t_options: Array<UmbDocumentVariantOptionModel> = [];\r\n\r\n\t@state()\r\n\t_selection: Array<string> = [];\r\n\r\n\t@state()\r\n\t_canUnpublish = true;\r\n\r\n\t@state()\r\n\t_hasInvalidSelection = true;\r\n\r\n\t@state()\r\n\t_isInvariant = false;\r\n\r\n\t@state()\r\n\t_referencesConfig?: UmbConfirmActionModalEntityReferencesConfig;\r\n\r\n\t#pickableFilter = (option: UmbDocumentVariantOptionModel) => {\r\n\t\tif (!option.variant) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\treturn this.data?.pickableFilter ? this.data.pickableFilter(option) : true;\r\n\t};\r\n\r\n\toverride firstUpdated() {\r\n\t\tthis.#configureReferences();\r\n\r\n\t\t// If invariant, don't display the variant selection component.\r\n\t\tif (this.data?.options.length === 1 && this.data.options[0].culture === null) {\r\n\t\t\tthis._isInvariant = true;\r\n\t\t\tthis._hasInvalidSelection = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.#configureSelectionManager();\r\n\t}\r\n\r\n\t#configureReferences() {\r\n\t\tif (!this.data?.documentUnique) return;\r\n\r\n\t\tthis._referencesConfig = {\r\n\t\t\titemRepositoryAlias: UMB_DOCUMENT_ITEM_REPOSITORY_ALIAS,\r\n\t\t\treferenceRepositoryAlias: UMB_DOCUMENT_REFERENCE_REPOSITORY_ALIAS,\r\n\t\t\tunique: this.data.documentUnique,\r\n\t\t};\r\n\t}\r\n\r\n\tasync #configureSelectionManager() {\r\n\t\tthis._selectionManager.setMultiple(true);\r\n\t\tthis._selectionManager.setSelectable(true);\r\n\r\n\t\t// Only display variants that are relevant to pick from, i.e. variants that are published or published with pending changes.\r\n\t\t// If we don't know the state (e.g. from a bulk publishing selection) we need to consider it available for selection.\r\n\t\tthis._options =\r\n\t\t\tthis.data?.options.filter((option) => (option.variant && option.variant.state === null) || isPublished(option)) ??\r\n\t\t\t[];\r\n\r\n\t\tlet selected = this.value?.selection ?? [];\r\n\r\n\t\tconst validOptions = this._options.filter((o) => this.#pickableFilter(o));\r\n\r\n\t\t// Filter selection based on options:\r\n\t\tselected = selected.filter((s) => validOptions.some((o) => o.unique === s));\r\n\r\n\t\tthis._selectionManager.setSelection(selected);\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis._selectionManager.selection,\r\n\t\t\t(selection) => {\r\n\t\t\t\tthis._selection = selection;\r\n\t\t\t\tconst selectionHasMandatory = this._options.some((o) => o.language.isMandatory && selection.includes(o.unique));\r\n\t\t\t\tconst selectionDoesNotHaveAllMandatory = this._options.some(\r\n\t\t\t\t\t(o) => o.language.isMandatory && !selection.includes(o.unique),\r\n\t\t\t\t);\r\n\t\t\t\tthis._hasInvalidSelection = selectionHasMandatory && selectionDoesNotHaveAllMandatory;\r\n\t\t\t},\r\n\t\t\t'observeSelection',\r\n\t\t);\r\n\t}\r\n\r\n\t#submit() {\r\n\t\tif (this._canUnpublish) {\r\n\t\t\tconst selection = this._isInvariant ? ['invariant'] : this._selection;\r\n\t\t\tthis.value = { selection };\r\n\t\t\tthis.modalContext?.submit();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.modalContext?.reject();\r\n\t}\r\n\r\n\t#close() {\r\n\t\tthis.modalContext?.reject();\r\n\t}\r\n\r\n\tasync #onReferencesChange(event: UmbChangeEvent) {\r\n\t\tevent.stopPropagation();\r\n\t\tconst target = event.target as UmbConfirmActionModalEntityReferencesElement;\r\n\t\tconst getReferencedByTotal = target.getTotalReferencedBy();\r\n\t\tconst descendantsWithReferencesTotal = target.getTotalDescendantsWithReferences();\r\n\t\tconst total = getReferencedByTotal + descendantsWithReferencesTotal;\r\n\r\n\t\tif (total > 0) {\r\n\t\t\tconst context = await this.getContext(UMB_DOCUMENT_CONFIGURATION_CONTEXT);\r\n\t\t\tthis._canUnpublish = (await context?.getDocumentConfiguration())?.disableUnpublishWhenReferenced === false;\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _requiredFilter = (variantOption: UmbDocumentVariantOptionModel): boolean => {\r\n\t\treturn variantOption.language.isMandatory && !this._selection.includes(variantOption.unique);\r\n\t};\r\n\r\n\toverride render() {\r\n\t\treturn html`<uui-dialog-layout headline=${this.localize.term('content_unpublish')}>\r\n\t\t\t<p>\r\n\t\t\t\t<umb-localize key=\"prompt_confirmUnpublish\"></umb-localize>\r\n\t\t\t</p>\r\n\t\t\t${when(\r\n\t\t\t\t!this._isInvariant,\r\n\t\t\t\t() => html`\r\n\t\t\t\t\t<umb-document-variant-language-picker\r\n\t\t\t\t\t\t.selectionManager=${this._selectionManager}\r\n\t\t\t\t\t\t.variantLanguageOptions=${this._options}\r\n\t\t\t\t\t\t.requiredFilter=${this._hasInvalidSelection ? this._requiredFilter : undefined}\r\n\t\t\t\t\t\t.pickableFilter=${this.#pickableFilter}></umb-document-variant-language-picker>\r\n\t\t\t\t`,\r\n\t\t\t)}\r\n\t\t\t${this._referencesConfig\r\n\t\t\t\t? html`<umb-confirm-action-modal-entity-references\r\n\t\t\t\t\t\t.config=${this._referencesConfig}\r\n\t\t\t\t\t\t@change=${this.#onReferencesChange}></umb-confirm-action-modal-entity-references>`\r\n\t\t\t\t: nothing}\r\n\r\n\t\t\t<div slot=\"actions\">\r\n\t\t\t\t<uui-button label=${this.localize.term('general_close')} @click=${this.#close}></uui-button>\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tlabel=\"${this.localize.term('actions_unpublish')}\"\r\n\t\t\t\t\t?disabled=${this._hasInvalidSelection ||\r\n\t\t\t\t\t!this._canUnpublish ||\r\n\t\t\t\t\t(!this._isInvariant && this._selection.length === 0)}\r\n\t\t\t\t\tlook=\"primary\"\r\n\t\t\t\t\tcolor=\"warning\"\r\n\t\t\t\t\t@click=${this.#submit}></uui-button>\r\n\t\t\t</div>\r\n\t\t</uui-dialog-layout> `;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t\tmin-width: 600px;\r\n\t\t\t\tmax-width: 90vw;\r\n\t\t\t}\r\n\r\n\t\t\t#references {\r\n\t\t\t\t--uui-table-cell-padding: 0;\r\n\t\t\t}\r\n\r\n\t\t\t#references-warning {\r\n\t\t\t\tmargin-top: 1rem;\r\n\t\t\t\tbackground-color: var(--uui-color-danger);\r\n\t\t\t\tcolor: var(--uui-color-danger-contrast);\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UmbDocumentUnpublishModalElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-document-unpublish-modal': UmbDocumentUnpublishModalElement;\r\n\t}\r\n}\r\n"],"names":["_pickableFilter","_UmbDocumentUnpublishModalElement_instances","configureReferences_fn","configureSelectionManager_fn","submit_fn","close_fn","onReferencesChange_fn","isPublished","option","UmbDocumentVariantState","UmbDocumentUnpublishModalElement","UmbModalBaseElement","__privateAdd","UmbSelectionManager","variantOption","__privateMethod","html","when","__privateGet","nothing","UMB_DOCUMENT_ITEM_REPOSITORY_ALIAS","UMB_DOCUMENT_REFERENCE_REPOSITORY_ALIAS","selected","validOptions","o","s","selection","selectionHasMandatory","selectionDoesNotHaveAllMandatory","event","target","getReferencedByTotal","descendantsWithReferencesTotal","context","UMB_DOCUMENT_CONFIGURATION_CONTEXT","UmbTextStyles","css","__decorateClass","state","customElement","UmbDocumentUnpublishModalElement$1"],"mappings":"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"}