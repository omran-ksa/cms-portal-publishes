{"version":3,"file":"media-picker.tiptap-toolbar-api-XAcggXJn.js","sources":["../../../src/packages/tiptap/extensions/toolbar/media-picker.tiptap-toolbar-api.ts"],"sourcesContent":["import { UmbTiptapToolbarElementApiBase } from '../base.js';\r\nimport { getGuidFromUdi, imageSize } from '@umbraco-cms/backoffice/utils';\r\nimport { ImageCropModeModel } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport { UmbImagingRepository } from '@umbraco-cms/backoffice/imaging';\r\nimport { UMB_MEDIA_CAPTION_ALT_TEXT_MODAL, UMB_MEDIA_PICKER_MODAL } from '@umbraco-cms/backoffice/media';\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport type { Editor } from '@umbraco-cms/backoffice/external/tiptap';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbMediaCaptionAltTextModalValue } from '@umbraco-cms/backoffice/media';\r\n\r\nexport default class UmbTiptapToolbarMediaPickerToolbarExtensionApi extends UmbTiptapToolbarElementApiBase {\r\n\t#imagingRepository = new UmbImagingRepository(this);\r\n\r\n\t#modalManager?: typeof UMB_MODAL_MANAGER_CONTEXT.TYPE;\r\n\r\n\t/**\r\n\t * @returns {number} The configured maximum allowed image size\r\n\t */\r\n\tget maxImageSize(): number {\r\n\t\tconst maxImageSize = parseInt(this.configuration?.getValueByAlias('maxImageSize') ?? '', 10);\r\n\t\treturn isNaN(maxImageSize) ? 500 : maxImageSize;\r\n\t}\r\n\r\n\t/**\r\n\t * @deprecated Use `maxImageSize` instead.\r\n\t * @returns {number} The maximum width of uploaded images\r\n\t */\r\n\tmaxWidth = this.maxImageSize;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.consumeContext(UMB_MODAL_MANAGER_CONTEXT, (instance) => {\r\n\t\t\tthis.#modalManager = instance;\r\n\t\t});\r\n\t}\r\n\r\n\toverride isActive(editor?: Editor) {\r\n\t\treturn editor?.isActive('image') === true || editor?.isActive('figure') === true;\r\n\t}\r\n\r\n\toverride async execute(editor: Editor) {\r\n\t\tconst currentTarget = editor.getAttributes('image');\r\n\t\tconst figure = editor.getAttributes('figure');\r\n\r\n\t\tlet currentMediaUdi: string | undefined = undefined;\r\n\t\tif (currentTarget?.['data-udi']) {\r\n\t\t\tcurrentMediaUdi = getGuidFromUdi(currentTarget['data-udi']);\r\n\t\t}\r\n\r\n\t\tlet currentAltText: string | undefined = undefined;\r\n\t\tif (currentTarget?.alt) {\r\n\t\t\tcurrentAltText = currentTarget.alt;\r\n\t\t}\r\n\r\n\t\tlet currentCaption: string | undefined = undefined;\r\n\t\tif (figure?.figcaption) {\r\n\t\t\tcurrentCaption = figure.figcaption;\r\n\t\t}\r\n\r\n\t\tconst selection = await this.#openMediaPicker(currentMediaUdi);\r\n\t\tif (!selection?.length) return;\r\n\r\n\t\tconst mediaGuid = selection[0];\r\n\r\n\t\tif (!mediaGuid) {\r\n\t\t\tthrow new Error('No media selected');\r\n\t\t}\r\n\r\n\t\tconst media = await this.#showMediaCaptionAltText(mediaGuid, currentAltText, currentCaption);\r\n\t\tif (!media) return;\r\n\r\n\t\tthis.#insertInEditor(editor, mediaGuid, media);\r\n\t}\r\n\r\n\tasync #openMediaPicker(currentMediaUdi?: string) {\r\n\t\tconst modalHandler = this.#modalManager?.open(this, UMB_MEDIA_PICKER_MODAL, {\r\n\t\t\tdata: {\r\n\t\t\t\tmultiple: false,\r\n\t\t\t\t//startNodeIsVirtual,\r\n\t\t\t},\r\n\t\t\tvalue: {\r\n\t\t\t\tselection: currentMediaUdi ? [currentMediaUdi] : [],\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tif (!modalHandler) return;\r\n\r\n\t\tconst { selection } = await modalHandler.onSubmit().catch(() => ({ selection: undefined }));\r\n\r\n\t\treturn selection;\r\n\t}\r\n\r\n\tasync #showMediaCaptionAltText(mediaUnique: string, altText?: string, caption?: string) {\r\n\t\tconst modalHandler = this.#modalManager?.open(this, UMB_MEDIA_CAPTION_ALT_TEXT_MODAL, {\r\n\t\t\tdata: { mediaUnique },\r\n\t\t\tvalue: {\r\n\t\t\t\turl: '',\r\n\t\t\t\taltText,\r\n\t\t\t\tcaption,\r\n\t\t\t},\r\n\t\t});\r\n\t\tconst mediaData = await modalHandler?.onSubmit().catch(() => null);\r\n\t\treturn mediaData;\r\n\t}\r\n\r\n\tasync #insertInEditor(editor: Editor, mediaUnique: string, media: UmbMediaCaptionAltTextModalValue) {\r\n\t\tif (!media?.url) return;\r\n\r\n\t\tconst maxImageSize = this.maxImageSize;\r\n\r\n\t\t// Get the resized image URL\r\n\t\tconst { data } = await this.#imagingRepository.requestResizedItems([mediaUnique], {\r\n\t\t\twidth: maxImageSize,\r\n\t\t\theight: maxImageSize,\r\n\t\t\tmode: ImageCropModeModel.MAX,\r\n\t\t});\r\n\r\n\t\tif (!data?.length || !data[0]?.url) {\r\n\t\t\tconsole.error('No data returned from imaging repository');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Set the media URL to the first item in the data array\r\n\t\tconst src = data[0].url;\r\n\r\n\t\t// Fetch the actual image dimensions\r\n\t\tconst { width, height } = await imageSize(src);\r\n\r\n\t\tconst img = {\r\n\t\t\tsrc,\r\n\t\t\talt: media.altText,\r\n\t\t\t'data-udi': `umb://media/${mediaUnique.replace(/-/g, '')}`,\r\n\t\t\twidth: width.toString(),\r\n\t\t\theight: height.toString(),\r\n\t\t};\r\n\r\n\t\tif (media.caption) {\r\n\t\t\treturn editor.commands.insertContent({\r\n\t\t\t\ttype: 'figure',\r\n\t\t\t\tcontent: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttype: 'paragraph',\r\n\t\t\t\t\t\tcontent: [\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\ttype: 'image',\r\n\t\t\t\t\t\t\t\tattrs: img,\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t],\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttype: 'figcaption',\r\n\t\t\t\t\t\tcontent: [\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\ttype: 'text',\r\n\t\t\t\t\t\t\t\ttext: media.caption,\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t],\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\treturn editor.commands.setImage(img);\r\n\t}\r\n}\r\n"],"names":["UmbTiptapToolbarMediaPickerToolbarExtensionApi","UmbTiptapToolbarElementApiBase","host","#imagingRepository","UmbImagingRepository","UMB_MODAL_MANAGER_CONTEXT","instance","#modalManager","maxImageSize","editor","currentTarget","figure","currentMediaUdi","getGuidFromUdi","currentAltText","currentCaption","selection","#openMediaPicker","mediaGuid","media","#showMediaCaptionAltText","#insertInEditor","modalHandler","UMB_MEDIA_PICKER_MODAL","mediaUnique","altText","caption","UMB_MEDIA_CAPTION_ALT_TEXT_MODAL","data","ImageCropModeModel","src","width","height","imageSize","img"],"mappings":"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"}